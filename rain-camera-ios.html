<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen">
    <title>Rain Camera - iOS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            position: fixed;
        }

        #videoContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        #rainCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        #permissionScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #D4B896 0%, #1C1C1C 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            color: white;
            text-align: center;
            padding: 20px;
        }

        #permissionScreen.hidden {
            display: none;
        }

        .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        p {
            font-size: 17px;
            opacity: 0.9;
            margin-bottom: 30px;
            max-width: 300px;
            line-height: 1.4;
        }

        #startButton {
            background: white;
            color: #1C1C1C;
            border: none;
            padding: 16px 48px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            -webkit-appearance: none;
        }

        #startButton:active {
            transform: scale(0.95);
        }

        #errorMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 24px 32px;
            border-radius: 12px;
            z-index: 100;
            display: none;
            text-align: center;
            max-width: 85%;
            font-size: 16px;
            line-height: 1.5;
        }

        #caption {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 15px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.7);
            z-index: 3;
            opacity: 0.85;
            text-align: center;
            padding: 0 20px;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .platform-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            z-index: 11;
        }
    </style>
</head>
<body>
    <!-- Platform Badge -->
    <div class="platform-badge">iOS</div>

    <!-- Permission Screen -->
    <div id="permissionScreen">
        <div class="icon" style="font-size: 80px; font-family: serif; font-weight: 300; letter-spacing: 3px; line-height: 1;">
            <div style="font-size: 48px; margin-bottom: 10px;">â™ž</div>
            <div style="font-size: 20px; font-weight: 500; letter-spacing: 4px;">BURBERRY</div>
        </div>
        <h1>Let's Get Drenched in Burberry</h1>
        <p>Allow camera access to begin your journey</p>
        <button id="startButton">Start Experience</button>
    </div>

    <!-- Camera Feed -->
    <div id="videoContainer">
        <video id="video" playsinline autoplay muted webkit-playsinline></video>
    </div>

    <!-- Rain Overlay Canvas -->
    <canvas id="rainCanvas"></canvas>

    <!-- Optional Caption -->
    <div id="caption" style="display: none;">
        <!-- Add your text here if needed -->
    </div>

    <!-- Error Message -->
    <div id="errorMessage"></div>

    <script>
        class RainEffect {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.drops = [];
                this.maxDrops = 120; // Slightly fewer for iOS performance
                this.init();
            }

            init() {
                this.resize();
                window.addEventListener('resize', () => this.resize());
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.resize(), 100);
                });
                this.createDrops();
                this.animate();
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            createDrops() {
                this.drops = [];
                for (let i = 0; i < this.maxDrops; i++) {
                    this.drops.push(this.createDrop());
                }
            }

            createDrop() {
                return {
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height - this.canvas.height,
                    length: Math.random() * 25 + 15, // Longer drops
                    speed: Math.random() * 2.5 + 2,
                    opacity: Math.random() * 0.35 + 0.3,
                    width: Math.random() * 4 + 3 // Thickness of droplet
                };
            }

            update() {
                for (let drop of this.drops) {
                    drop.y += drop.speed;
                    
                    if (drop.y > this.canvas.height) {
                        drop.y = -drop.length;
                        drop.x = Math.random() * this.canvas.width;
                    }
                }
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                for (let drop of this.drops) {
                    // Create fat rounded droplet shape
                    const centerX = drop.x;
                    const topY = drop.y;
                    const bottomY = drop.y + drop.length;
                    const width = drop.width;
                    
                    // Main droplet body with gradient (glass-like)
                    const gradient = this.ctx.createRadialGradient(
                        centerX - width/3, topY + drop.length/3, 0,
                        centerX, topY + drop.length/2, width
                    );
                    gradient.addColorStop(0, `rgba(255, 255, 255, ${drop.opacity * 1.2})`);
                    gradient.addColorStop(0.5, `rgba(220, 235, 255, ${drop.opacity * 0.8})`);
                    gradient.addColorStop(1, `rgba(200, 220, 255, ${drop.opacity * 0.4})`);
                    
                    // Draw elongated rounded droplet
                    this.ctx.beginPath();
                    this.ctx.fillStyle = gradient;
                    
                    // Top rounded cap
                    this.ctx.arc(centerX, topY + width/2, width/2, Math.PI, 0);
                    
                    // Body
                    this.ctx.lineTo(centerX + width/2, bottomY - width/2);
                    
                    // Bottom rounded cap (tapered)
                    this.ctx.arc(centerX, bottomY - width/2, width/2, 0, Math.PI);
                    
                    // Close path
                    this.ctx.lineTo(centerX - width/2, topY + width/2);
                    this.ctx.fill();
                    
                    // Add bright highlight (light reflection)
                    const highlightGradient = this.ctx.createRadialGradient(
                        centerX - width/4, topY + width, 0,
                        centerX - width/4, topY + width, width/2
                    );
                    highlightGradient.addColorStop(0, `rgba(255, 255, 255, ${drop.opacity * 0.9})`);
                    highlightGradient.addColorStop(1, `rgba(255, 255, 255, 0)`);
                    
                    this.ctx.beginPath();
                    this.ctx.fillStyle = highlightGradient;
                    this.ctx.arc(centerX - width/4, topY + width, width/2.5, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // Add subtle outer glow
                    this.ctx.beginPath();
                    this.ctx.strokeStyle = `rgba(255, 255, 255, ${drop.opacity * 0.3})`;
                    this.ctx.lineWidth = 1;
                    this.ctx.arc(centerX, topY + width/2, width/2 + 1, Math.PI, 0);
                    this.ctx.lineTo(centerX + width/2 + 1, bottomY - width/2);
                    this.ctx.arc(centerX, bottomY - width/2, width/2 + 1, 0, Math.PI);
                    this.ctx.lineTo(centerX - width/2 - 1, topY + width/2);
                    this.ctx.stroke();
                }
            }

            animate() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.animate());
            }
        }

        class CameraApp {
            constructor() {
                this.video = document.getElementById('video');
                this.permissionScreen = document.getElementById('permissionScreen');
                this.startButton = document.getElementById('startButton');
                this.errorMessage = document.getElementById('errorMessage');
                this.rainEffect = null;
                this.stream = null;

                this.startButton.addEventListener('click', () => this.requestCamera());
                
                // Handle page visibility for iOS
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.stream) {
                        // Pause when tab is hidden
                        this.video.pause();
                    } else if (!document.hidden && this.stream) {
                        // Resume when tab is visible
                        this.video.play();
                    }
                });
            }

            async requestCamera() {
                this.startButton.innerHTML = '<div class="spinner"></div>';
                this.startButton.disabled = true;

                try {
                    // iOS Safari optimized constraints
                    const constraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                    
                    // iOS requires explicit play() call
                    this.video.onloadedmetadata = () => {
                        this.video.play().then(() => {
                            this.permissionScreen.classList.add('hidden');
                            
                            if (!this.rainEffect) {
                                this.rainEffect = new RainEffect(document.getElementById('rainCanvas'));
                            }
                        }).catch(error => {
                            console.error('Video play error:', error);
                            this.showError('Unable to start camera. Please tap to try again.');
                            this.startButton.innerHTML = 'Try Again';
                            this.startButton.disabled = false;
                        });
                    };

                } catch (error) {
                    console.error('Camera access error:', error);
                    this.showError(this.getErrorMessage(error));
                    this.startButton.innerHTML = 'Try Again';
                    this.startButton.disabled = false;
                }
            }

            getErrorMessage(error) {
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    return 'Camera access denied.\n\nPlease go to Settings > Safari > Camera and allow access.';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    return 'No camera found on this device.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    return 'Camera is already in use.\n\nPlease close other apps using the camera.';
                } else if (error.name === 'SecurityError') {
                    return 'Camera access blocked.\n\nPlease use HTTPS or enable camera in iOS settings.';
                } else {
                    return 'Unable to access camera.\n\nPlease try again or check your settings.';
                }
            }

            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
                setTimeout(() => {
                    this.errorMessage.style.display = 'none';
                }, 6000);
            }
        }

        // Initialize app
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => new CameraApp());
        } else {
            new CameraApp();
        }

        // Prevent iOS bounce/scroll
        document.body.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>
